/*
 * Click nbfs://nbhost/SystemFileSystem/Templates/Licenses/license-default.txt to change this license
 * Click nbfs://nbhost/SystemFileSystem/Templates/GUIForms/JPanel.java to edit this template
 */
package sistemabsensi.user.ui;

import java.sql.SQLException;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.Timer;
import java.util.TimerTask;
import javax.swing.JOptionPane;
import javax.swing.table.DefaultTableModel;
import sistemabsensi.database.DBAbsensi;
import sistemabsensi.database.data.RecordAbsen;
import sistemabsensi.database.data.Shift;

/**
 *
 * @author rss
 */
public class JPanelAbsen extends javax.swing.JPanel {

	private JFrameAbsensi frameAbsensi;
	private DBAbsensi dbAbsensi;
	private Timer timer;

	/**
	 * Creates new form JPanelAbsen
	 */
	public JPanelAbsen(JFrameAbsensi frameAbsensi) {
		this.frameAbsensi = frameAbsensi;
		this.dbAbsensi = frameAbsensi.getDB();
		initComponents();

		this.comboModeAbsen.addItem("MASUK KERJA");
		this.comboModeAbsen.addItem("PULANG KERJA");
		this.comboModeAbsen.addItem("ISTIRAHAT");
		this.comboModeAbsen.addItem("KEMBALI ISTIRAHAT");
		this.timer = new Timer();
		this.timer.scheduleAtFixedRate(new TimerTask() {
			public void run() {
				LocalTime waktu = LocalTime.now();
				DateTimeFormatter format = DateTimeFormatter.ofPattern("hh:mm:ss a");

				labelWaktu.setText(waktu.format(format));
			}
		}, 0, 1000);
	}

	/**
	 * This method is called from within the constructor to initialize the
	 * form. WARNING: Do NOT modify this code. The content of this method is
	 * always regenerated by the Form Editor.
	 */
	@SuppressWarnings("unchecked")
        // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
        private void initComponents() {

                comboModeAbsen = new javax.swing.JComboBox<>();
                labelWaktu = new javax.swing.JLabel();
                btnAbsen = new javax.swing.JButton();
                jScrollPane1 = new javax.swing.JScrollPane();
                tabelData = new javax.swing.JTable();
                comboDaftarTanggalRecord = new javax.swing.JComboBox<>();
                btnLogout = new javax.swing.JButton();
                jCheckBox1 = new javax.swing.JCheckBox();
                jScrollPane3 = new javax.swing.JScrollPane();
                jTable1 = new javax.swing.JTable();

                setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

                comboModeAbsen.setFont(comboModeAbsen.getFont().deriveFont(comboModeAbsen.getFont().getStyle() | java.awt.Font.BOLD));
                comboModeAbsen.setModel(new javax.swing.DefaultComboBoxModel<>());
                comboModeAbsen.addActionListener(new java.awt.event.ActionListener() {
                        public void actionPerformed(java.awt.event.ActionEvent evt) {
                                comboModeAbsenActionPerformed(evt);
                        }
                });
                add(comboModeAbsen, new org.netbeans.lib.awtextra.AbsoluteConstraints(240, 120, 170, 30));

                labelWaktu.setBackground(new java.awt.Color(255, 255, 255));
                labelWaktu.setFont(new java.awt.Font("sansserif", 0, 36)); // NOI18N
                labelWaktu.setForeground(new java.awt.Color(51, 204, 0));
                labelWaktu.setText("00:00:00 AM");
                labelWaktu.setHorizontalTextPosition(javax.swing.SwingConstants.CENTER);
                add(labelWaktu, new org.netbeans.lib.awtextra.AbsoluteConstraints(560, 40, 230, 80));

                btnAbsen.setFont(new java.awt.Font("sansserif", 0, 48)); // NOI18N
                btnAbsen.setText("ABSEN");
                btnAbsen.addActionListener(new java.awt.event.ActionListener() {
                        public void actionPerformed(java.awt.event.ActionEvent evt) {
                                btnAbsenActionPerformed(evt);
                        }
                });
                add(btnAbsen, new org.netbeans.lib.awtextra.AbsoluteConstraints(240, 40, 290, -1));

                tabelData.setModel(new javax.swing.table.DefaultTableModel(
                        new Object [][] {
                                {null, null, null, null},
                                {null, null, null, null},
                                {null, null, null, null},
                                {null, null, null, null}
                        },
                        new String [] {
                                "Title 1", "Title 2", "Title 3", "Title 4"
                        }
                ));
                tabelData.setShowGrid(true);
                jScrollPane1.setViewportView(tabelData);

                add(jScrollPane1, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 180, 560, 370));

                comboDaftarTanggalRecord.setModel(new javax.swing.DefaultComboBoxModel<>());
                comboDaftarTanggalRecord.addActionListener(new java.awt.event.ActionListener() {
                        public void actionPerformed(java.awt.event.ActionEvent evt) {
                                comboDaftarTanggalRecordActionPerformed(evt);
                        }
                });
                add(comboDaftarTanggalRecord, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 560, 180, 30));

                btnLogout.setText("Logout");
                btnLogout.addActionListener(new java.awt.event.ActionListener() {
                        public void actionPerformed(java.awt.event.ActionEvent evt) {
                                btnLogoutActionPerformed(evt);
                        }
                });
                add(btnLogout, new org.netbeans.lib.awtextra.AbsoluteConstraints(710, 560, -1, 30));

                jCheckBox1.setText("jCheckBox1");
                jCheckBox1.addActionListener(new java.awt.event.ActionListener() {
                        public void actionPerformed(java.awt.event.ActionEvent evt) {
                                jCheckBox1ActionPerformed(evt);
                        }
                });
                add(jCheckBox1, new org.netbeans.lib.awtextra.AbsoluteConstraints(420, 120, 110, 30));

                jTable1.setModel(new javax.swing.table.DefaultTableModel(
                        new Object [][] {
                                {null, null, null, null},
                                {null, null, null, null},
                                {null, null, null, null},
                                {null, null, null, null}
                        },
                        new String [] {
                                "Title 1", "Title 2", "Title 3", "Title 4"
                        }
                ));
                jScrollPane3.setViewportView(jTable1);

                add(jScrollPane3, new org.netbeans.lib.awtextra.AbsoluteConstraints(580, 180, 210, 370));
        }// </editor-fold>//GEN-END:initComponents

	private void dapatkanDataRecord() {
		try {
			DefaultTableModel model = new DefaultTableModel();
			model.addColumn("Tanggal");
			model.addColumn("Absen Masuk");
			model.addColumn("Absen Pulang");
			model.addColumn("Absen Istirahat");
			model.addColumn("Absen Kembali Istirahat");
			this.comboDaftarTanggalRecord.removeAllItems();

			for (RecordAbsen record : this.dbAbsensi.getDaftarRecordAbsenKaryawan(this.frameAbsensi.getKaryawan().getIdKaryawan())) {
				this.comboDaftarTanggalRecord.addItem(record.getTglRecord().toString());
				Object[] dataBaris = {record.getTglRecord(), record.getWaktuMasuk(), record.getWaktuPulang(), record.getWaktuIstirahat(), record.getWaktuSelesaiIstirahat()};
				model.addRow(dataBaris);
			}
			this.tabelData.setModel(model);
		} catch (SQLException ex) {
			ex.printStackTrace();
			System.exit(-1);
		}
	}

	private void dapatkanDataJadwalShift() {
		DefaultTableModel model = new DefaultTableModel();
		model.addColumn("Masuk - Pulang");
		model.addColumn("Istirahat");
		
		Shift shift = frameAbsensi.getKaryawan().getShift();
		
		Object[] baris = { shift.getWaktuMasuk() + " - " + shift.getWaktuPulang(), shift.getWaktuIstirahat() + " - " + shift.getWaktuSelesaiIstirahat()};
		model.addRow(baris);
		
		//this.jTable1.setModel(model);

	}

	private void tampilkanPesan(String pesan) {
		JOptionPane.showMessageDialog(this, pesan);
	}

        private void btnAbsenActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAbsenActionPerformed

		// TODO: 
		// PROMPT: !PULANG -> MASUK KERJA -> ((!KEMBALI ISTIRAHAT -> ISTIRAHAT -> KEMBALI ISTIRAHAT) || PULANG)
		try {
			RecordAbsen record = frameAbsensi.getKaryawan().getRecordAbsen();
			switch (comboModeAbsen.getItemAt(comboModeAbsen.getSelectedIndex())) {
				case "MASUK KERJA":
					if (record.getWaktuMasuk() != null) {
						tampilkanPesan("ANDA SUDAH ABSEN MASUK");
						return;
					} else if (record.getWaktuPulang() != null) {
						tampilkanPesan("Anda Sudah Absen Pulang!");
						return;
					}
					record.catatWaktuMasuk();
					break;
				case "PULANG KERJA":
					if (record.getWaktuPulang() != null) {
						tampilkanPesan("ANDA SUDAH ABSEN Pulang");
						return;
					}
					record.catatWaktuPulang();
					break;
				case "ISTIRAHAT":
					if (record.getWaktuIstirahat() != null) {
						tampilkanPesan("Anda Sudah Absen Istirahat");
						return;
					}
					record.catatWaktuIstirahat();
					break;
				case "KEMBALI ISTIRAHAT":
					if (record.getWaktuSelesaiIstirahat() != null) {
						tampilkanPesan("Anda Sudah Absen Kembali Istirahat");
						return;
					}
					record.catatWaktuSelesaiIstirahat();
					break;
			}

			this.dbAbsensi.updateRecordAbsenKaryawan(this.frameAbsensi.getKaryawan().getRecordAbsen());
			this.frameAbsensi.setKaryawan(this.dbAbsensi.getDataKaryawan(this.frameAbsensi.getKaryawan().getIdKaryawan()));
			this.dapatkanDataRecord();
		} catch (SQLException ex) {
			ex.printStackTrace();
			System.exit(-1);
		}
        }//GEN-LAST:event_btnAbsenActionPerformed

        private void comboModeAbsenActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_comboModeAbsenActionPerformed
		// TODO add your handling code here:
        }//GEN-LAST:event_comboModeAbsenActionPerformed

        private void btnLogoutActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnLogoutActionPerformed
		this.frameAbsensi.setKaryawan(null);
		this.frameAbsensi.bukaPanelLogin();
        }//GEN-LAST:event_btnLogoutActionPerformed

        private void comboDaftarTanggalRecordActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_comboDaftarTanggalRecordActionPerformed
		// TODO add your handling code here:
        }//GEN-LAST:event_comboDaftarTanggalRecordActionPerformed

        private void jCheckBox1ActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jCheckBox1ActionPerformed
                // TODO add your handling code here:
        }//GEN-LAST:event_jCheckBox1ActionPerformed


        // Variables declaration - do not modify//GEN-BEGIN:variables
        private javax.swing.JButton btnAbsen;
        private javax.swing.JButton btnLogout;
        private javax.swing.JComboBox<String> comboDaftarTanggalRecord;
        private javax.swing.JComboBox<String> comboModeAbsen;
        private javax.swing.JCheckBox jCheckBox1;
        private javax.swing.JScrollPane jScrollPane1;
        private javax.swing.JScrollPane jScrollPane3;
        private javax.swing.JTable jTable1;
        private javax.swing.JLabel labelWaktu;
        private javax.swing.JTable tabelData;
        // End of variables declaration//GEN-END:variables

	public void dapatkanData() {
		//this.dapatkanDataJadwalShift();
		this.dapatkanDataRecord();
	}
}
